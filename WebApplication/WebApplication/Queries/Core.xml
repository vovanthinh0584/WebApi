<?xml version="1.0" encoding="utf-8"?>
<Statements>
  <Statement id="Core_GetPriority">
    SELECT * FROM Priority
    WHERE MedicalRecordId = @MedicalRecordId OR @MedicalRecordId = 0
  </Statement>
  <Statement id="Core_SetPriority">
    IF EXISTS (SELECT TOP 1 1 FROM [Priority] WHERE MedicalRecordId = @MedicalRecordId)
    UPDATE [Priority] SET IsPriority = @IsPriority WHERE MedicalRecordId = @MedicalRecordId
    ELSE
    INSERT INTO [Priority](MedicalRecordId, IsPriority)
    VALUES (@MedicalRecordId, @IsPriority)
  </Statement>
  <Statement id="Core_GetLastQuestions">
    DECLARE @LastTime DATETIME = NULL
    DECLARE @HistoryId int = NULL
    DECLARE @Temp int = NULL
    SELECT @LastTime = SubmitTime, @HistoryId = Id FROM History WHERE MedicalRecordId = @MedicalRecordId
    AND SubmitTime >= (SELECT MAX(SubmitTime) FROM History WHERE MedicalRecordId = @MedicalRecordId)

    IF @HistoryId IS NULL
    SELECT q.Id, q.ParentId, q.Content, q.SurveyId, q.Value, st.Name SurveyName from Question q
    JOIN Survey st ON st.Id = q.SurveyId
    WHERE q.SurveyId = @SurveyId
    ELSE
    SELECT q.Id, q.ParentId, q.Content, q.SurveyId, ISNULL(s.Value, q.Value) Value, st.Name SurveyName from Question q
    JOIN Survey st ON st.Id = q.SurveyId
    LEFT JOIN Selection s ON s.QuestionId = q.Id
    LEFT JOIN History h ON h.Id = s.HistoryId
    WHERE h.SubmitTime = @LastTime
    AND h.MedicalRecordId = @MedicalRecordId
    AND q.SurveyId = @SurveyId
    OR q.ParentId IS NULL

  </Statement>
  <Statement id="Core_GetSurveys">
    SELECT Id, Name FROM Survey
  </Statement>
  <Statement id="Core_AddHistory">
    BEGIN TRANSACTION
    
    INSERT INTO History (PatientCode, MedicalRecordId, SubmitTime)
    VALUES (@PatientCode, @MedicalRecordId, @SubmitTime)

    DECLARE @HistoryId INT = NULL
    SET @HistoryId = (SELECT SCOPE_IDENTITY())

    INSERT INTO Selection(HistoryId, QuestionId, Value)
    SELECT @HistoryId, QuestionId, Value
    FROM OPENJSON (@JSON)
    WITH (
    QuestionId Int,
    Value NVARCHAR(MAX)
    )

    COMMIT TRANSACTION
  </Statement>
</Statements>